macros:
    - &linux
      language: c
      os: linux
      dist: xenial
      compiler: clang
      addons:
          apt:
              packages:
                  - ninja-build
      install:
          - source ~/virtualenv/python3.6/bin/activate
          - pip install meson
      script:
          - meson build $MESON_OPTS
          - ninja -C build
          - wget http://dl-cdn.alpinelinux.org/alpine/v3.9/releases/x86/alpine-minirootfs-3.9.4-x86.tar.gz -O alpine.tar.gz
          - ./tools/fakefsify.py alpine.tar.gz alpine
          - grep nameserver /etc/resolv.conf | head -1 | ./build/ish -f ./alpine /bin/sed -n "w /etc/resolv.conf"
          - bash e2e.bash

matrix:
    include:
        - <<: *linux
          env: MESON_OPTS=-Djit=true
        - <<: *linux
          env: MESON_OPTS=-Djit=false
        - language: objective-c
          osx_image: xcode10.1
          install:
              - pip3 install meson==0.49.2
          addons:
              homebrew:
                  packages:
                      - ninja
                      - llvm
                      - yarn
          script:
              - xcodebuild -project iSH.xcodeproj -scheme iSH -sdk iphoneos CODE_SIGNING_ALLOWED=NO
    exclude:
        - language: objective-c
          env: MESON_OPTS=-Djit=false
